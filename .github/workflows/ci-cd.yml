name: Deploy

on:
  workflow_run:
    workflows:
      - CI
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script_stop: true
          script: |
            set -euo pipefail
            export CI=true
            cd /home/pdh/PDH
            git fetch --all
            git checkout main
            git pull origin main
            ./scripts/run-pnpm.sh install --no-frozen-lockfile --force
            ./scripts/run-pnpm.sh -C packages/engine build
            ./scripts/run-pnpm.sh -C apps/nakama build
            docker compose --env-file .env -f docker-compose.prod.yml up -d postgres
            docker compose --env-file .env -f docker-compose.prod.yml run --rm nakama-migrate
            docker compose --env-file .env -f docker-compose.prod.yml up -d --force-recreate nakama
            ./scripts/run-pnpm.sh -C apps/web build
            sudo -n /bin/systemctl restart pdh-web
            curl -fsS https://api.bondipoker.online/healthcheck >/dev/null

      - name: Smoke test
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script_stop: true
          script: |
            set -euo pipefail
            cd /home/pdh/PDH
            SMOKE_SERVER_KEY='${{ secrets.SMOKE_SERVER_KEY }}' ./scripts/remote-smoke.sh --url https://api.bondipoker.online --ssl true --clients 4
